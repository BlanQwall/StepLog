<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StepLog | Weekly Template</title>
  <!-- 注意：模板在 weeklog/ 目录里，所以要用 ../style.css -->
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <!-- 顶部脚本：统一控制这一周的起始日期 & 标题 & 日期范围 & 每日日期 -->
<script>
  // ✅ 每周页面复制这个模板后，只需要改这一行：
  // 这一周的「周一」日期，格式 YYYY-MM-DD
  const WEEK_START = "2025-11-17";

  // 把 "YYYY-MM-DD" 解析成一个“UTC 日期对象”，避免本地时区干扰
  function makeUTCDate(ymdStr) {
    const [y, m, d] = ymdStr.split("-").map(Number);
    return new Date(Date.UTC(y, m - 1, d));
  }

  // 以“UTC 日历”输出 YYYY-MM-DD，不经过本地时区
  function formatUTCDate(date) {
    const y = date.getUTCFullYear();
    const m = String(date.getUTCMonth() + 1).padStart(2, "0");
    const d = String(date.getUTCDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function computeWeekDates(startStr) {
    const start = makeUTCDate(startStr);
    const end = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000); // +6 days

    return {
      startStr: formatUTCDate(start),
      endStr: formatUTCDate(end),
      label: `Week ${formatUTCDate(start)}`,
      dateRange: `${formatUTCDate(start)} → ${formatUTCDate(end)}`,
    };
  }

  document.addEventListener("DOMContentLoaded", () => {
    const info = computeWeekDates(WEEK_START);

    // 设置页面标题
    document.title = `StepLog | ${info.label}`;

    // 填充顶部标题 & 周日期
    document.querySelectorAll("[data-week-label]").forEach((el) => {
      el.textContent = info.label;
    });
    document.querySelectorAll("[data-week-dates]").forEach((el) => {
      el.textContent = info.dateRange;
    });

    // 为「每日计划表」自动填日期（Mon–Sun）
    const base = makeUTCDate(info.startStr);
    document.querySelectorAll("tr[data-day-offset]").forEach((row) => {
      const offset = Number(row.getAttribute("data-day-offset") || "0");
      const d = new Date(base.getTime() + offset * 24 * 60 * 60 * 1000);
      const dateStr = formatUTCDate(d);
      const cell = row.querySelector("[data-day-date]");
      if (cell) {
        cell.textContent = dateStr;
      }
    });
  });
</script>


  <!-- 顶部导航 -->
  <header class="site-header">
    <div class="container header-inner">
      <div class="logo">StepLog</div>
      <nav class="nav">
        <a href="../index.html">Home</a>
        <!-- 这里不用写 href，index.html 里已经有「Current Week」导航 -->
        <a>Weekly View</a>
      </nav>
    </div>
  </header>

  <!-- 当前周概览 -->
  <section class="section week-hero">
    <div class="container">
      <h1 data-week-label>Week</h1>
      <p class="section-subtitle">
        Planning first, execution later — this is your structured weekly cycle page.
      </p>

      <div class="week-meta-row">
        <div class="meta-pill">
          <span class="meta-label">Week dates</span>
          <span class="meta-value" data-week-dates>YYYY-MM-DD → YYYY-MM-DD</span>
        </div>
        <div class="meta-pill">
          <span class="meta-label">Training cycle</span>
          <span class="meta-value">Cycle X · Week Y</span>
        </div>
        <div class="meta-pill">
          <span class="meta-label">Focus</span>
          <span class="meta-value">Main focus of this week</span>
        </div>
      </div>
    </div>
  </section>

  <!-- 1 · Weekly Planning -->
  <section class="section section-alt">
    <div class="container">
      <h2>1 · Weekly Planning</h2>
      <p class="section-subtitle">
        This section is filled <strong>before</strong> the week starts: Garmin plan, weekly goals, and per-day sessions.
      </p>

      <!-- 上半部分：Garmin 截图 + 周目标 -->
      <div class="week-planning-grid">
        <!-- 左：Garmin 计划日历 -->
        <div>
          <h3 class="week-subtitle">Garmin calendar (planned)</h3>
          <figure class="week-figure">
            <!-- 这里放你本周的 Garmin 截图，可以每周覆盖同一个文件 -->
            <img
              src="../assets/garmin-week-plan.png"
              alt="Planned Garmin calendar for this week"
              class="week-img"
            />
            <figcaption class="week-caption">
              Garmin Connect · Weekly plan view
            </figcaption>
          </figure>
          <p class="week-note">
            Replace this image each week with a new Garmin calendar screenshot matching the plan below.
          </p>
        </div>

        <!-- 右：本周目标 -->
        <div>
          <h3 class="week-subtitle">Weekly goal</h3>
          <div class="week-goal-card">
            <p class="week-goal-main">
              Main goal:
              <strong>Example — Build volume with controlled intensity</strong>
            </p>
            <ul class="week-goal-list">
              <li>Target weekly distance: <strong>XX km</strong></li>
              <li>Key session 1: <strong>Tempo run …</strong></li>
              <li>Key session 2: <strong>Long run …</strong></li>
              <li>Secondary focus: <strong>Strength / mobility …</strong></li>
            </ul>
          </div>

          <h3 class="week-subtitle week-subtitle-margin">Context / constraints</h3>
          <div class="week-context-card">
            <ul class="week-context-list">
              <li>Example: Busy work days on Tue & Thu evening.</li>
              <li>Example: Watch sleep quality before tempo / long run.</li>
              <li>Example: Weather may push long run to Sat/Sun.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- 下半部分：每日计划表（日期自动填充） -->
      <div class="week-table-block">
        <h3 class="week-subtitle">Planned sessions (day by day)</h3>
        <table class="week-table">
          <thead>
            <tr>
              <th>Day</th>
              <th>Date</th>
              <th>Session type</th>
              <th>Details</th>
              <th>Priority</th>
            </tr>
          </thead>
          <tbody>
            <tr data-day-offset="0">
              <td>Mon</td>
              <td data-day-date>DATE</td>
              <td>Easy run</td>
              <td>Example: 8–10 km easy, relaxed cadence.</td>
              <td>Main</td>
            </tr>
            <tr data-day-offset="1">
              <td>Tue</td>
              <td data-day-date>DATE</td>
              <td>Rest / strength</td>
              <td>Example: 30 min strength + 10 min mobility.</td>
              <td>Optional</td>
            </tr>
            <tr data-day-offset="2">
              <td>Wed</td>
              <td data-day-date>DATE</td>
              <td>Quality / tempo</td>
              <td>Example: 2 km WU + 6–8 km tempo + 2 km CD.</td>
              <td>Key</td>
            </tr>
            <tr data-day-offset="3">
              <td>Thu</td>
              <td data-day-date>DATE</td>
              <td>Recovery</td>
              <td>Example: 6–8 km very easy + strides × 4.</td>
              <td>Support</td>
            </tr>
            <tr data-day-offset="4">
              <td>Fri</td>
              <td data-day-date>DATE</td>
              <td>Easy</td>
              <td>Example: 8–10 km easy, focus on breathing.</td>
              <td>Main</td>
            </tr>
            <tr data-day-offset="5">
              <td>Sat</td>
              <td data-day-date>DATE</td>
              <td>Long run</td>
              <td>Example: 18–20 km comfortable, last 3 km slightly faster.</td>
              <td>Key</td>
            </tr>
            <tr data-day-offset="6">
              <td>Sun</td>
              <td data-day-date>DATE</td>
              <td>Rest / walk</td>
              <td>Example: Rest or 30–40 min walk + stretching.</td>
              <td>Optional</td>
            </tr>
          </tbody>
        </table>
        <p class="week-note">
          Fill this table before the week starts. Execution details go in the section below.
        </p>
      </div>
    </div>
  </section>

  <!-- 2 · Execution & Weekly Summary -->
  <section id="summary" class="section">
    <div class="container">
      <h2>2 · Execution & Weekly Summary</h2>
      <p class="section-subtitle">
        This section is filled during and after the week: Strava data + your own notes and feelings.
      </p>

      <!-- 顶部：指标（部分自动填充） -->
      <div class="week-summary-metrics">
        <div class="metric-card">
          <p class="metric-label">Planned distance</p>
          <!-- 这个你可以手动改，和上面计划保持一致 -->
          <p class="metric-value">XX km</p>
        </div>
        <div class="metric-card">
          <p class="metric-label">Completed distance</p>
          <!-- 由 JS + week-YYYY-MM-DD.json 自动填 -->
          <p class="metric-value"><span id="completed-distance">–</span></p>
        </div>
        <div class="metric-card">
          <p class="metric-label">Sessions</p>
          <!-- 由 JS 自动填活动数量 -->
          <p class="metric-value"><span id="session-count">–</span></p>
        </div>
        <div class="metric-card">
          <p class="metric-label">General feeling</p>
          <!-- 这个留给你手动写，例如 7/10 -->
          <p class="metric-value">–</p>
        </div>
      </div>

      <div class="week-execution-grid">
        <!-- 左侧：从 Strava 读出的本周活动列表 -->
        <div>
          <h3 class="week-subtitle">Executed sessions (from Strava)</h3>
          <ul id="week-activity-list" class="week-context-list">
            <li>Activities will be loaded from JSON…</li>
          </ul>
        </div>

        <!-- 右侧：你的主观反思 -->
        <div>
          <h3 class="week-subtitle">Overall reflection</h3>
          <div class="week-reflection-card">
            <h4>What went well</h4>
            <p>Write your own notes here at the end of the week.</p>

            <h4>What was difficult</h4>
            <p>Example: Tempo felt hard after poor sleep, etc.</p>

            <h4>Adjustments for next week</h4>
            <p>Example: Move key session away from the heaviest workday.</p>
          </div>
        </div>
      </div>

      <div class="week-final-note">
        <h3 class="week-subtitle">One-line takeaway for future me</h3>
        <p>Example: “Protect sleep before tempo and long run — it changes everything.”</p>
      </div>
    </div>
  </section>

  <footer class="site-footer">
    <div class="container footer-inner">
      <p>StepLog · Weekly Template</p>
      <p class="footer-sub">Plan first, then learn from each week.</p>
    </div>
  </footer>

  <!-- 底部脚本：根据 WEEK_START 自动加载 ../data/week-YYYY-MM-DD.json -->
  <script>
    // 假设你用 build_week.py 生成的文件名是 week-<WEEK_START>.json
    const WEEK_JSON = `../data/week-${WEEK_START}.json`;

    async function loadWeekData() {
      try {
        const res = await fetch(WEEK_JSON);
        if (!res.ok) {
          console.error("Failed to load week JSON", res.status);
          return;
        }

        const data = await res.json();
        console.log("Week data loaded:", data);

        // 1) Completed distance & Sessions
