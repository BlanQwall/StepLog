name: Deploy CN site to COS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 生成 deploy-cn 目录（你现有逻辑，保持不变）
      - name: Build deploy-cn folder
        run: |
          chmod +x build-cn.sh
          ./build-cn.sh

      # 安装 coscmd
      - name: Install coscmd
        run: |
          python -m pip install --upgrade pip
          pip install coscmd

      # 配置 coscmd（固定香港区域）
      - name: Configure coscmd
        env:
          TENCENT_SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
          TENCENT_SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}
        run: |
          coscmd config \
            -a "$TENCENT_SECRET_ID" \
            -s "$TENCENT_SECRET_KEY" \
            -u 1390433657 \
            -b steplog-cn-1390433657 \
            -r ap-hongkong \
            -m 30 \
            -p 10

      # 上传站点文件（覆盖模式 + 重试，避免网络抖动）
      - name: Upload deploy-cn to COS (overwrite, retry)
        run: |
          for i in 1 2 3; do
            echo "Upload attempt $i..."
            coscmd upload -rs ./deploy-cn/ / -f && break
            echo "Upload failed, retrying in 10 seconds..."
            sleep 10
          done
